# Generated by ansible
*filter
# By default, drop incoming packets
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
# Allow all incoming connections to loopback
-A INPUT -i lo -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
# Allow SSH connections on the VPN
{% for instance in openvpn_instances %}
-A INPUT -p tcp -d {{ instance.cidr }} --dport 22 -j ACCEPT
{% endfor %}

# Ansible ssh_on_vpn_only set to: {{ ssh_on_vpn_only }}
# {% if ssh_on_vpn_only == true %}Uncomment to {% endif %}Allow SSH connections on the default interface
{% if ssh_on_vpn_only == true %}#{% endif %}-A INPUT -p tcp -i {{ ansible_default_ipv4.interface }} --dport 22 -j ACCEPT

# Allow VPN connections to dnsmasq
{% for instance in openvpn_instances %}
-A INPUT -p udp -d {{ instance.gateway }} --dport 53 -j ACCEPT
{% endfor %}
# Allow connections to the VPN
{% for instance in openvpn_instances %}
-A INPUT -p {{ instance.proto }} --dport {{ instance.port }} -j ACCEPT
{% endfor %}
-A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
{% for instance in openvpn_instances %}
-A FORWARD -s {{ instance.cidr }} -j ACCEPT
{% endfor %}
COMMIT
*nat
:PREROUTING ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
{% for instance in openvpn_instances %}
-A POSTROUTING -s {{ instance.cidr }} -o {{ ansible_default_ipv4.interface }} -j MASQUERADE
{% endfor %}
COMMIT
